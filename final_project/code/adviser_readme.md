# 景深/倾斜建议工具（adviser.py）

该工具用于在“轴移镜头”方案中，从一张已拍摄的图片评估景深分布与画面清晰度，自动给出镜头微倾的轴与方向建议，帮助将模糊一侧纳入合焦范围。

## 工作原理（概述）

1. 网格化清晰度评估
   - 将图像划分为 G×G 网格（默认 20×20），
   - 每个网格计算 Tenengrad 梯度能量（Sobel 梯度平方和），作为该区域的“锐度”指标（越大越清晰）。

2. 拟合“锐度平面”
   - 把每个网格中心坐标归一化到 [-1, 1]，对锐度做对数压缩（log1p），
   - 以最小二乘拟合平面 z = a·x + b·y + c，
   - 平面的法向量投影（a, b）刻画了“锐度随位置变化的梯度方向”。

3. 倾斜方向判定
   - 梯度方向（a, b）指向“锐度增加的方向”，说明该侧更清晰；
   - 为把模糊一侧纳入景深，应将镜头向“锐度较弱的一侧”微倾，即沿梯度反方向微调；
   - 方向映射：
     - up/down → 绕水平轴（x 轴）微倾；
     - left/right → 绕垂直轴（y 轴）微倾；
   - 同时根据梯度强弱给出 small / moderate / strong 的幅度级别，用于提示试探角度应更小或更大。

4. 质量快速判定（可选）
   - 计算整体锐度中位数与曝光截断比例（死黑/高光像素占比），
   - 给出 PASS / WARN / FAIL 的快速质量判断与文字提示（如“整体偏虚”“高光溢出较多”等），
   - 目的在于在“全局虚焦/曝光极端”的情形下，优先提醒先对焦/调曝光，而不是盲目倾斜。

## 输出内容

- 终端打印：质量判定（可选）与倾斜建议（轴、方向、幅度说明）。
- 叠加热力图（PNG）：叠加在原灰度图上的锐度热力图，暖色更清晰，便于直观观察清晰度分布。
- JSON 报告：包含平面系数 a、b、c，梯度向量与方向建议、质量判定指标（若启用）等详细字段。

## 使用方法（PowerShell）

在 `final_project/code` 目录下执行：

```powershell
# 默认分析 ..\figures 中按名称“最新”的一张，输出到 .\adviser_out
python .\adviser.py

# 指定单张图片
ython .\adviser.py --image ..\figures\img_0009.png

# 指定输出目录与网格密度（越大越精细，但稍慢）
python .\adviser.py --out-dir .\adviser_out --grid 24
```

参数说明：
- `--image`：指定单张图片；若不指定，则在 `--images-dir`（默认 `..\figures`）下选取按名称排序的最后一张；
- `--grid`：网格数（默认 20），建议 16–32；
- `--out-dir`：输出目录，包含热力图与 JSON 报告。

## 结果解读与建议

- 当梯度方向明显（moderate/strong）且一侧清晰、一侧模糊，优先沿建议的轴与方向做小角度试探；
- 当整体锐度偏低或曝光极端（大量死黑/高光），倾斜难以补救，应先重新合焦/调整曝光；
- 若锐度分布近似均匀，说明倾斜收益有限，可保持现状或仅做极小试探；
- 结合你已有的 `quality.py` 综合评分，可在“评分差、梯度明显”的情况下更积极地执行微倾策略。

## 局限与注意事项

- 本方法以“锐度-空间分布”近似代替真实景深测量，适合静态、纹理足够的场景；
- 强噪声/纹理稀少/运动模糊会影响锐度估计，可提高光照、缩短曝光或增大网格以增强稳健性；
- 倾斜建议仅提供“方向与相对幅度等级”，实际角度需结合镜头规格与经验逐步试探；
- 如需面向特定景深厚度/距离的精确光圈与倾角规划，可结合镜头参数应用 Scheimpflug/Hinge 的近似公式进行计算。
